# Dev Plan â€” 2026-02-14: Thinking/Reasoning Best-Effort + RC Hardening

**Branch:** `feature/multi-provider-endpoints`
**Predecessor:** `ad0ba14` (Unified REASONING fold + provider thinking fixes)
**Reference:** `docs/thinking_research.md`

---

## Objective

Complete the "best effort" thinking/reasoning support across all providers and harden the codebase for Release Candidate readiness.

---

## Phase 1: Thinking Activation Fixes

### 1.1 â€” Ollama Native: Send `think: true` (P0)

**Problem:** Ollama thinking-capable models (deepseek-r1, qwq, qwen3) require `"think": true` in the request body. ExecPrompt never sends it, so local reasoning models skip their thinking step entirely.

**Fix:** In `OllamaApiService` (or wherever the native `/api/chat` request body is constructed), add `"think": true` to the request payload.

**Consideration:** Should this be unconditional or conditional? Options:
- **Unconditional** â€” Always send `think: true`. Non-thinking models ignore it. Simplest approach.
- **Conditional on model name** â€” Only send for known thinking models. Fragile and incomplete.
- **User toggle** â€” Tie to existing "send parameters" UI. Adds complexity.

**Recommendation:** Unconditional. Ollama's API gracefully ignores `think: true` for non-thinking models. Adding it to every request is safe and requires zero UI changes.

**Files:** `lib/data/services/ollama_api_service.dart`
**Effort:** ~5 lines

---

### 1.2 â€” Anthropic: Temperature Guard (P1)

**Problem:** Anthropic's extended thinking requires `temperature` to be exactly 1.0 or omitted. If a user sets temperature via ExecPrompt's parameter controls, the API may reject the request or silently disable thinking.

**Fix:** When `thinking` is enabled in the request body, ensure temperature is not set (or forced to 1.0). If the user has set a custom temperature, either:
- Strip it and log a note, or
- Override to 1.0

**Files:** `lib/data/services/anthropic_adapter.dart`
**Effort:** ~5 lines

---

### 1.3 â€” Anthropic: Budget Scaling (P2, Optional)

**Problem:** `budget_tokens: 10000` is hardcoded. For complex tasks, users might want more; for quick tasks, less.

**Options:**
- **Auto-scale by max_tokens** â€” Set budget to ~50% of max_tokens, min 1024, max 32000
- **Expose in UI** â€” Add a thinking budget slider to Parameters section
- **Leave as-is** â€” 10000 is a reasonable general-purpose default

**Recommendation:** Auto-scale: `budget_tokens = max(1024, min((maxTokens * 0.5).toInt(), 32000))`. No UI needed. If `num_predict` isn't set, default to 10000.

**Files:** `lib/data/services/anthropic_adapter.dart`
**Effort:** ~10 lines

---

## Phase 2: Security & Sanity Scrub (AUDIT COMPLETE)

**Audit Date:** 2026-02-14
**Result:** 4 CRITICAL, 5 WARNING, 12 CLEAN areas

### 2.1 â€” CRITICAL: Endpoint.toString() Leaks API Keys (C1)

**Finding:** Freezed-generated `toString()` in `endpoint.freezed.dart` includes raw `apiKey` value. Any exception trace or debug log that stringifies an Endpoint object **emits the API key in plain text** to `adb logcat`.

**Fix:** Override `toString()` in the Endpoint model to redact `apiKey`:
```dart
@override
String toString() => 'Endpoint(id: $id, name: $name, type: $type, apiKey: [REDACTED])';
```

**Files:** `lib/data/models/endpoint.dart`
**Effort:** ~3 lines

---

### 2.2 â€” CRITICAL: Ollama Adapter Logs Full Request/Response Bodies (C2/C3)

**Finding:** Two `debugPrint` calls in `ollama_api_service.dart`:
- Line 45: `debugPrint('ðŸ“¤ Request: ${request.toJson()}')` â€” logs entire message history
- Line 68: `debugPrint('ðŸ“„ Line: $line')` â€” logs every streaming token

These run in release builds (Flutter `debugPrint` is NOT stripped in release mode).

**Fix:** Remove both lines, or wrap in `kDebugMode` guard.

**Files:** `lib/data/services/ollama_api_service.dart`
**Effort:** ~4 lines

---

### 2.3 â€” CRITICAL: Search API Keys in Plain SharedPreferences (C4)

**Finding:** `tavily_api_key` and `ollama_cloud_search_key` are stored in **plain SharedPreferences**, unlike endpoint API keys which correctly use `flutter_secure_storage`.

**Locations in `settings_provider.dart`:**
- L149: `prefs.getString('ollama_cloud_search_key')`
- L154: `prefs.getString('tavily_api_key')`
- L294: `prefs.setString('ollama_cloud_search_key', key)`
- L304: `prefs.setString('tavily_api_key', key)`

**Fix:** Migrate both keys to `flutter_secure_storage`. Add migration path (read old â†’ write new â†’ delete old).

**Files:** `lib/domain/providers/settings_provider.dart`
**Effort:** ~30 lines (including migration)

---

### 2.4 â€” WARNING: All debugPrint Calls Run in Release Builds (W1)

**Finding:** ~40+ `debugPrint` calls across 6 files. Zero `kDebugMode` guards anywhere in codebase. All operational logging is visible via `adb logcat` in production APKs.

**Fix:** Add centralized logger utility or wrap all calls: `if (kDebugMode) debugPrint(...)`

**Files:** All files with `debugPrint` calls
**Effort:** ~40 line changes (mechanical)

---

### 2.5 â€” WARNING: local.properties Tracked in Git (W3)

**Finding:** `android/local.properties` committed. Contains environment-specific SDK paths.

**Fix:** Add to `.gitignore`, remove from tracking: `git rm --cached android/local.properties`

---

### 2.6 â€” Audit Results: CLEAN Areas

The following passed audit with no issues:
- [x] âœ… Endpoint API keys â€” `flutter_secure_storage` with `AndroidOptions(encryptedSharedPreferences: true)`
- [x] âœ… `@JsonKey(includeFromJson: false, includeToJson: false)` on apiKey â€” prevents serialization
- [x] âœ… All AnimationControllers properly disposed (blinking_cursor, search_status_indicator, message_bubble)
- [x] âœ… Timer disposal with mounted check (thinking_status_indicator)
- [x] âœ… ScrollController listeners removed and disposed (adaptive_shell, chat_screen)
- [x] âœ… StreamSubscription lifecycle managed (chat_provider: cancel on dispose/new request/stop/completion)
- [x] âœ… All three adapters: comprehensive try/catch for DioException, malformed JSON, cancellation
- [x] âœ… Zero hardcoded API keys, tokens, or secrets
- [x] âœ… Zero TODO/FIXME/HACK/XXX comments
- [x] âœ… `wrangler.toml` clean (only KV namespace IDs, non-secret vars)
- [x] âœ… Sound null safety throughout
- [x] âœ… `build/` directory properly gitignored
- [ ] Check for TODO/FIXME/HACK comments that indicate incomplete work
- [ ] Verify `.gitignore` excludes build artifacts, secrets, IDE configs

---

## Phase 3: RC Enhancement Assessment

Review and document potential enhancements for "first class power user tool" status. These are candidates for post-RC sprints, not blocking items.

### Candidate Enhancements

| Enhancement | Value | Effort | Priority |
|---|---|---|---|
| Conversation export (JSON/Markdown) | High â€” users want to save/share conversations | Medium | Post-RC |
| Model favorites / pinning | Medium â€” quick access to preferred models | Low | Post-RC |
| Token usage display per message | Medium â€” power users want cost visibility | Medium | Post-RC |
| Keyboard shortcuts | Medium â€” power user efficiency | Low | Post-RC |
| System prompt library / templates | High â€” reusable prompt configurations | Medium | Post-RC |
| Response diff / comparison | Medium â€” compare model outputs | High | Future |
| Local conversation search | High â€” find past conversations | Medium | Post-RC |

---

## Commit Plan

| Commit | Scope | Priority |
|---|---|---|
| 1 | C1: Endpoint toString redaction | CRITICAL |
| 2 | C2/C3: Remove/guard verbose debugPrint in ollama_api_service | CRITICAL |
| 3 | C4: Migrate search keys to flutter_secure_storage | CRITICAL |
| 4 | W1: Wrap all debugPrint in kDebugMode | WARNING |
| 5 | Phase 1.1: Ollama `think: true` | HIGH |
| 6 | Phase 1.2 + 1.3: Anthropic temperature guard + budget scaling | MEDIUM |
| 7 | W3 + W4: gitignore fixes | LOW |

**Note:** Security CRITICALs should be addressed before any feature work.

---

## Decision Points for Review

1. **Ollama `think: true` unconditional?** â€” Recommended yes. Confirm before implementation.
2. **Anthropic budget auto-scale vs. static?** â€” Recommended auto-scale. Confirm approach.
3. **Any Phase 3 enhancements to pull into RC?** â€” Recommend none; ship clean then enhance.
